<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>預購詳細名單</title>

<style>
body {
    font-family: Arial;
    background: #0d0d0d;
    color: white;
    padding: 25px;
}

.glass {
    backdrop-filter: blur(14px);
    background: rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 20px;
    border: 1px solid rgba(255,255,255,0.25);
    box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

th, td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.25);
}

th {
    cursor: pointer;
    color: #ffe98a;
}

tr:hover {
    background: rgba(255,255,255,0.15);
}

#search-box {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: white;
    margin-top: 10px;
}

.floating-btn {
    position: fixed;
    right: 25px;
    bottom: 25px;
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(10px);
    border-radius: 22px;
    padding: 20px 32px;
    font-size: 18px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.4);
    box-shadow: 0 0 12px rgba(255,255,255,0.25);
}
</style>
</head>

<body>
<h1>806 園遊會預購詳細名單</h1>

<div class="glass">
    <input id="search-box" placeholder="搜尋姓名 / 單位 / 餐點 / 備註" />
    
    <table id="data-table">
        <thead>
            <tr>
                <th data-col="0">運送位置 ⬍</th>
                <th data-col="1">姓名 ⬍</th>
                <th data-col="2">餐點 ⬍</th>
                <th data-col="3">份數 ⬍</th>
                <th data-col="4">金額 ⬍</th>
                <th data-col="5">收款 ⬍</th>
                <th data-col="6">備註 ⬍</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <tr><td colspan="7">資料讀取中...</td></tr>
        </tbody>
    </table>
</div>

<div class="floating-btn" onclick="window.location.href='index.html'">
    回到總覽 ⇦
</div>

<script>
// Google Sheet JSON API
const apiURL =
  "https://docs.google.com/spreadsheets/d/1lmsxOD90L1oNa7XMoM1c5jzwZ05mpxUfiCBIa_DBpkA/gviz/tq?gid=0&tqx=out:json";

let tableData = [];
let sortState = { col: null, asc: true };

// --- 抓資料 ---
function fetchDetailData() {
    fetch(apiURL)
        .then(res => res.json()) // ⚠️ 修正: 直接解析 JSON
        .then(data => {
            // ⚠️ 修正: 使用 index.html 成功存取的結構 (假設 '預購' 是資料陣列的 key)
            const rows = data.預購 || []; // 如果不是 '預購'，請檢查實際的 JSON 結構

            tableData = rows
                .map(r => {
                    // 假設 Google Sheet 的每一行資料的 key 就是標題列
                    // 根據 th 的順序調整這裡的 key
                    return [
                        r["運送位置"] ?? "", 
                        r["姓名"] ?? "", 
                        r["餐點"] ?? "", 
                        r["份數"] ?? "", 
                        r["金額"] ?? "", 
                        r["收款"] ?? "", 
                        r["備註"] ?? "" 
                    ];
                })
                .filter(row => row.some(v => v !== "")); // 過濾空列

            renderTable(tableData);
        })
        .catch(err => {
            console.error("讀取 Google Sheets 失敗:", err);
            document.getElementById("table-body").innerHTML =
                `<tr><td colspan="7">讀取失敗</td></tr>`;
        });
}

// --- 渲染表格 ---
function renderTable(data) {
    let html = "";
    data.forEach(row => {
        html += "<tr>";
        row.forEach(cell => html += `<td>${cell}</td>`);
        html += "</tr>";
    });
    document.getElementById("table-body").innerHTML = html;
}

// --- 搜尋 ---
document.getElementById("search-box").addEventListener("input", function () {
    const keyword = this.value.toLowerCase();
    const filtered = tableData.filter(row =>
        row.some(cell => String(cell).toLowerCase().includes(keyword))
    );
    renderTable(filtered);
});

// --- 排序 ---
document.querySelectorAll("th").forEach(th => {
    th.addEventListener("click", () => {
        // ⚠️ 修正: 將 data-col 從字串轉為數字，以便正確存取陣列
        const col = Number(th.dataset.col);

        if (sortState.col === col) {
            sortState.asc = !sortState.asc;
        } else {
            sortState.col = col;
            sortState.asc = true;
        }

        tableData.sort((a, b) => {
            let x = a[col];
            let y = b[col];

            const numX = Number(x);
            const numY = Number(y);
            const isNumber = !isNaN(numX) && !isNaN(numY) && x !== "" && y !== ""; // 修正: 排除空字串導致的錯誤判斷

            if (isNumber) {
                x = numX;
                y = numY;
            } else {
                x = String(x);
                y = String(y);
            }

            return sortState.asc ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
        });

        renderTable(tableData);
    });
});

// 初始化
fetchDetailData();
</script>

</body>
</html>
