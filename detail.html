<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>預購明細</title>
<style>
body { background:#0d0d0d; font-family:'Arial'; color:white; padding:25px; }
.glass { backdrop-filter: blur(14px); background: rgba(255,255,255,0.15); border-radius:20px; padding:20px; border:1px solid rgba(255,255,255,0.25); box-shadow:0 4px 30px rgba(0,0,0,0.3); }
table { width:100%; border-collapse:collapse; font-size:15px; }
th, td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.2); }
th { cursor:pointer; user-select:none; }
#search { width:100%; padding:12px; margin-bottom:20px; border-radius:10px; border:none; background:rgba(255,255,255,0.2); color:white; backdrop-filter:blur(8px); }
#back { cursor:pointer; padding:10px 18px; margin-bottom:15px; border-radius:10px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(8px); color:white; }
</style>
</head>
<body>

<button id="back">← 返回儀表板</button>

<h1>預購明細</h1>
<input id="search" placeholder="搜尋姓名 / 餐點 / 單位 / 運送位置 / 班級 / 備註">

<div class="glass">
    <table id="table">
        <thead>
            <tr id="header-row"></tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
const url = 'https://api.sheety.co/ae4e08eb568eb1ace722b0a85d7fa564/806園遊會預購名單/預購';
let tableData = [];
let columns = [];

// 取得資料並重新整理
function fetchData() {
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const rows = data.預購;

            // 第一次載入 → 自動依照 API 欄位產生表頭
            if (columns.length === 0) {
                columns = Object.keys(rows[0]).filter(c => c !== "id");
                buildHeader();
            }

            // 整理成資料表格式
            tableData = rows.map(r => {
                let obj = {};
                columns.forEach(c => obj[c] = r[c] || "");
                return obj;
            });

            rebuildTable(tableData);
        })
        .catch(err => console.error("資料讀取失敗", err));
}

// 產生表頭
function buildHeader() {
    const headerRow = document.getElementById("header-row");
    headerRow.innerHTML = "";

    columns.forEach((col, idx) => {
        headerRow.innerHTML += `<th onclick="sortTable(${idx})">${col}</th>`;
    });
}

// 產生表格內容
function rebuildTable(data) {
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";

    data.forEach(row => {
        let tr = "<tr>";
        columns.forEach(c => {
            tr += `<td>${row[c]}</td>`;
        });
        tr += "</tr>";
        tb.innerHTML += tr;
    });
}

// 搜尋
document.getElementById("search").oninput = function () {
    const kw = this.value.toLowerCase();

    const filtered = tableData.filter(r =>
        Object.values(r).join(" ").toLowerCase().includes(kw)
    );

    rebuildTable(filtered);
};

// 排序
function sortTable(colIndex) {
    const colName = columns[colIndex];

    tableData.sort((a, b) => {
        const A = a[colName].toString();
        const B = b[colName].toString();
        return A.localeCompare(B, 'zh-Hant');
    });

    rebuildTable(tableData);
}

document.getElementById("back").onclick = () => location.href = 'index.html';

// 初次抓資料
fetchData();

// 每 10 秒自動更新
setInterval(fetchData, 10000);
</script>

</body>
</html>
