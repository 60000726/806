<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>806 園遊會資訊</title>

<style>
body {
    font-family: Arial;
    background: #0d0d0d;
    color: white;
    padding: 25px;
}

/* 玻璃卡片 */
.glass {
    backdrop-filter: blur(14px);
    background: rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.25);
    box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}

/* 格狀排版 */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 18px;
}

.title {
    font-size: 18px;
    opacity: 0.85;
}

.big-number {
    font-size: 48px;
    font-weight: bold;
    margin-top: 12px;
}

/* 資料更新閃爍 */
@keyframes flash {
    0% { background: rgba(255,255,255,0.4); }
    100% { background: rgba(255,255,255,0.12); }
}
.flash {
    animation: flash 0.5s;
}

/* 更新列 */
#update-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    font-size: 16px;
}
#refresh {
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(8px);
    color: white;
    cursor: pointer;
}

/* 右下角浮動按鈕 */
.floating-btn {
    position: fixed;
    right: 25px;
    bottom: 25px;
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(10px);
    border-radius: 22px;
    padding: 20px 32px;
    font-size: 20px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.4);
    box-shadow: 0 0 12px rgba(255,255,255,0.25);
}
</style>
</head>

<body>

<!-- 更新列 -->
<div id="update-bar">
    <span id="update-time">資料讀取中...</span>
    <button id="refresh">重新整理 ↻</button>
</div>

<h1>806 園遊會資訊</h1>

<!-- 第一列 -->
<div class="grid">
    <div class="glass" id="card-people">
        <div class="title">總人數</div>
        <div class="big-number" id="people-count">--</div>
    </div>

    <div class="glass" id="card-qty">
        <div class="title">總份數</div>
        <div class="big-number" id="total-qty">--</div>
    </div>

    <div class="glass" id="card-price">
        <div class="title">總金額</div>
        <div class="big-number" id="total-price">--</div>
    </div>

    <div class="glass" id="card-rank">
        <div class="title">預定單位排名</div>
        <div id="ranking">讀取中...</div>
    </div>
</div>

<!-- 第二列：炒泡麵 / 紅茶 / 套餐（同一行） -->
<div class="grid">
    <div class="glass" id="card-noodle">
        <div class="title">炒泡麵總數</div>
        <div class="big-number" id="noodle-count">--</div>
    </div>

    <div class="glass" id="card-tea">
        <div class="title">紅茶總數</div>
        <div class="big-number" id="tea-count">--</div>
    </div>

    <div class="glass" id="card-set">
        <div class="title">套餐總數（炒泡麵+紅茶）</div>
        <div class="big-number" id="set-count">--</div>
    </div>
</div>

<!-- 查看詳細 -->
<div class="floating-btn" onclick="location.href='detail.html'">
    查看詳細名單 ➜
</div>

<script>
const apiURL = "https://docs.google.com/spreadsheets/d/1lmsxOD90L1oNa7XMoM1c5jzwZ05mpxUfiCBIa_DBpkA/gviz/tq?gid=0&tqx=out:json";

let lastData = "";

// 抓資料
function fetchData() {
    fetch(apiURL)
        .then(r => r.text())
        .then(txt => {
            const jsonText = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1);
            const json = JSON.parse(jsonText);
            const rows = json.table.rows;

            const raw = rows.map(r => ({
                location: r.c[0]?.v || "",
                name:     r.c[1]?.v || "",
                item:     r.c[2]?.v || "",
                qty:      Number(r.c[3]?.v || 0),
                price:    Number(r.c[4]?.v || 0)
            }));

            const str = JSON.stringify(raw);
            if (str === lastData) return;  // 無變動
            lastData = str;

            updateUI(raw);
        })
        .catch(err => console.error(err));
}

function updateUI(data) {

    let people = new Set();
    let totalQty = 0;
    let totalPrice = 0;
    let locationCount = {};

    let noodle = 0;
    let tea = 0;
    let setMeal = 0;

    data.forEach(r => {
        if (r.name) people.add(r.name);
        totalQty += r.qty;
        totalPrice += r.price;

        if (r.location) {
            locationCount[r.location] = (locationCount[r.location] || 0) + r.qty;
        }

        if (r.item.includes("炒泡麵")) noodle += r.qty;
        if (r.item.includes("紅茶")) tea += r.qty;
        if (r.item.includes("套餐")) setMeal += r.qty;
    });

    // 更新數字
    document.getElementById("people-count").textContent = people.size;
    document.getElementById("total-qty").textContent = totalQty;
    document.getElementById("total-price").textContent = totalPrice;
    document.getElementById("noodle-count").textContent = noodle;
    document.getElementById("tea-count").textContent = tea;
    document.getElementById("set-count").textContent = setMeal;

    // 排名
    let sorted = Object.entries(locationCount).sort((a,b) => b[1] - a[1]);
    document.getElementById("ranking").innerHTML =
        sorted.map((x,i)=>`${i+1}. ${x[0]}（${x[1]}份）`).join("<br>");

    // 更新時間
    document.getElementById("update-time").textContent =
        "最後更新：" + new Date().toLocaleTimeString();

    // 閃爍動畫
    [
        "card-people", "card-qty", "card-price",
        "card-rank", "card-noodle", "card-tea", "card-set"
    ].forEach(id => {
        const el = document.getElementById(id);
        el.classList.remove("flash");
        void el.offsetWidth;
        el.classList.add("flash");
    });
}

// 手動刷新按鈕
document.getElementById("refresh").onclick = fetchData;

// 初始化 + 自動更新
fetchData();
setInterval(fetchData, 10000);
</script>

</body>
</html>
